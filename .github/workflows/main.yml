name: Checks
on:
  push:

jobs:
  calc-matrix:
    name: Find Checks üîç
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.calc-matrix.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix ‚ùÑÔ∏è
        uses: nixbuild/nix-quick-install-action@v30
        with:
          nix_on_tmpfs: true

      - name: Calculate Check üñ©
        id: calc-matrix
        run: |
          matrix=$(nix flake show --json | jq -c '.checks."x86_64-linux"|keys_unsorted')
          echo "Matrix: $matrix"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  checks:
    needs: calc-matrix
    strategy:
      fail-fast: false
      matrix:
        check: ${{ fromJson(needs.calc-matrix.outputs.matrix) }}
    runs-on: ubuntu-latest
    name: Check/${{ matrix.check }} ü§î

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix ‚ùÑÔ∏è
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run ${{ matrix.check }} üìã
        run: nix build .#checks.x86_64-linux.${{ matrix.check }} -L --show-trace
